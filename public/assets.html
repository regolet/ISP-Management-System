<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ISP Management System Assets">
  <title>ISP Management System - Assets</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  
  
  
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-inter">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-gradient-to-b from-blue-700 to-blue-800 text-white shadow-xl flex flex-col">
      <!-- Logo -->
      <div class="p-6 border-b border-blue-600">
        <a href="/dashboard.html" class="flex items-center space-x-3 hover:opacity-90 transition-opacity">
          <i class="fas fa-signal text-2xl"></i>
          <h1 class="text-xl font-bold">ISP Management</h1>
        </a>
      </div>
      
      <!-- Navigation -->
      <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
        <a href="/dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-tachometer-alt w-5"></i>
          <span>Dashboard</span>
        </a>
        <a href="/clients.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-users w-5"></i>
          <span>Clients</span>
        </a>
        <a href="/plans.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-project-diagram w-5"></i>
          <span>Plans</span>
        </a>
        <a href="/billings.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-file-invoice-dollar w-5"></i>
          <span>Billings</span>
        </a>
        <a href="/payments.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-credit-card w-5"></i>
          <span>Payments</span>
        </a>
        <a href="/assets.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-white/20 text-white font-medium">
          <i class="fas fa-cube w-5"></i>
          <span>Assets</span>
        </a>
        <a href="/inventory.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-boxes w-5"></i>
          <span>Inventory</span>
        </a>
        <a href="/tickets.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-ticket-alt w-5"></i>
          <span>Tickets</span>
        </a>
        <a href="/monitoring.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-chart-line w-5"></i>
          <span>Monitoring</span>
        </a>
        <a href="/settings.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-cogs w-5"></i>
          <span>Settings</span>
        </a>
      </nav>
      
      <!-- User Info -->
      <div class="p-4 border-t border-blue-600">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <i class="fas fa-user-circle text-2xl"></i>
            <span id="username" class="font-medium">Loading...</span>
          </div>
          <button 
            id="logoutBtn"
            class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors text-sm font-medium"
          >
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Top Header -->
      <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-gray-900">Assets</h2>
          <div class="flex items-center space-x-4">
            <span class="text-gray-600 text-sm">Manage your deployed assets</span>
          </div>
        </div>
      </header>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto bg-gray-100 px-6 py-8">
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <!-- Total Assets -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                  <i class="fas fa-cube text-blue-600"></i>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Total Assets</p>
                <p id="totalAssetsCount" class="text-2xl font-bold text-gray-900">0</p>
              </div>
            </div>
          </div>

          <!-- Active Assets -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                  <i class="fas fa-check-circle text-green-600"></i>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Active Assets</p>
                <p id="activeAssetsCount" class="text-2xl font-bold text-gray-900">0</p>
              </div>
            </div>
          </div>

          <!-- Total Collections -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                  <i class="fas fa-coins text-yellow-600"></i>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Total Collections</p>
                <p id="totalCollectionsAmount" class="text-2xl font-bold text-gray-900">₱0</p>
              </div>
            </div>
          </div>

          <!-- This Month Collections -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                  <i class="fas fa-calendar-alt text-purple-600"></i>
                </div>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">This Month</p>
                <p id="thisMonthCollections" class="text-2xl font-bold text-gray-900">₱0</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Assets List Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center mb-4 sm:mb-0">
              <i class="fas fa-cube text-blue-600 mr-2"></i>
              Asset Management
            </h3>
            <div class="flex items-center space-x-3">
              <input 
                type="text" 
                id="searchInput" 
                placeholder="Search assets..." 
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
              <select id="typeFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Types</option>
                <option value="vendo">Vendo Machine</option>
                <option value="computer">Computer</option>
                <option value="other">Other</option>
              </select>
              <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="maintenance">Maintenance</option>
              </select>
              <select id="itemsPerPage" class="px-2 py-1 border border-gray-300 rounded text-sm">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <button 
                onclick="openAddAssetModal()"
                class="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                <i class="fas fa-plus"></i>
                <span>Add Asset</span>
              </button>
            </div>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('name')">
                    <div class="flex items-center justify-between">
                      <span>Name</span>
                      <i id="sort-name" class="fas fa-sort text-gray-400"></i>
                    </div>
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('type')">
                    <div class="flex items-center justify-between">
                      <span>Type</span>
                      <i id="sort-type" class="fas fa-sort text-gray-400"></i>
                    </div>
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('location')">
                    <div class="flex items-center justify-between">
                      <span>Location</span>
                      <i id="sort-location" class="fas fa-sort text-gray-400"></i>
                    </div>
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('status')">
                    <div class="flex items-center justify-between">
                      <span>Status</span>
                      <i id="sort-status" class="fas fa-sort text-gray-400"></i>
                    </div>
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('total_collections')">
                    <div class="flex items-center justify-between">
                      <span>Total Collections</span>
                      <i id="sort-total_collections" class="fas fa-sort text-gray-400"></i>
                    </div>
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('last_collection_date')">
                    <div class="flex items-center justify-between">
                      <span>Last Collection</span>
                      <i id="sort-last_collection_date" class="fas fa-sort-down text-blue-500"></i>
                    </div>
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none" onclick="sortTable('subitems_count')">
                    <div class="flex items-center justify-between">
                      <span>Subitems</span>
                      <i id="sort-subitems_count" class="fas fa-sort text-gray-400"></i>
                    </div>
                  </th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="assetsTableBody" class="bg-white divide-y divide-gray-200">
                <tr>
                  <td colspan="8" class="px-6 py-12 text-center">
                    <div class="flex items-center justify-center">
                      <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mr-3"></div>
                      <span class="text-gray-500">Loading assets...</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <div class="px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-700">
                <span id="paginationStatus">Showing 0 to 0 of 0 entries</span>
              </div>
              <div class="flex items-center space-x-2">
                <button 
                  id="prevPageBtn" 
                  onclick="changePage(-1)" 
                  class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled
                >
                  <i class="fas fa-chevron-left mr-1"></i> Previous
                </button>
                <div id="pageNumbers" class="flex space-x-1">
                  <!-- Page numbers will be inserted here -->
                </div>
                <button 
                  id="nextPageBtn" 
                  onclick="changePage(1)" 
                  class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled
                >
                  Next <i class="fas fa-chevron-right ml-1"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Asset Modal -->
  <div id="addAssetModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Add New Asset</h3>
      </div>
      <form id="addAssetForm" class="p-6">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
            <input 
              type="text" 
              name="name" 
              required 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="e.g., Vendo Machine #1"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select 
              name="type" 
              required 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select Type</option>
              <option value="vendo">Vendo Machine</option>
              <option value="computer">Computer</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea 
              name="description" 
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Description of the asset"
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
            <input 
              type="text" 
              name="location" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Where is this asset deployed?"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
            <input 
              type="text" 
              name="serial_number" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Asset serial number"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
            <input 
              type="text" 
              name="model" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Asset model"
            >
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="closeAddAssetModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            Add Asset
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Asset Modal -->
  <div id="viewAssetModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Asset Details</h3>
        <button onclick="closeViewAssetModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="viewAssetContent" class="p-6">
        <!-- Asset details will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Edit Asset Modal -->
  <div id="editAssetModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Edit Asset</h3>
      </div>
      <form id="editAssetForm" class="p-6">
        <input type="hidden" id="editAssetId" name="id">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
            <input 
              type="text" 
              id="editAssetName"
              name="name" 
              required 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="e.g., Vendo Machine #1"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select 
              id="editAssetType"
              name="type" 
              required 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select Type</option>
              <option value="vendo">Vendo Machine</option>
              <option value="computer">Computer</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea 
              id="editAssetDescription"
              name="description" 
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Description of the asset"
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
            <input 
              type="text" 
              id="editAssetLocation"
              name="location" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Where is this asset deployed?"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select 
              id="editAssetStatus"
              name="status" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="maintenance">Maintenance</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Serial Number</label>
            <input 
              type="text" 
              id="editAssetSerial"
              name="serial_number" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Asset serial number"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
            <input 
              type="text" 
              id="editAssetModel"
              name="model" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Asset model"
            >
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="closeEditAssetModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            Update Asset
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Collections Modal -->
  <div id="collectionsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Asset Collections</h3>
        <div class="flex items-center space-x-3">
          <button 
            onclick="openAddCollectionModal()"
            class="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm"
          >
            <i class="fas fa-plus mr-1"></i>
            Add Collection
          </button>
          <button onclick="closeCollectionsModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="collectionsContent">
          <!-- Collections will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Add Collection Modal -->
  <div id="addCollectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Add Collection</h3>
      </div>
      <form id="addCollectionForm" class="p-6">
        <input type="hidden" id="collectionAssetId" name="asset_id">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Collection Date</label>
            <input 
              type="date" 
              name="collection_date" 
              required 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Amount (₱)</label>
            <input 
              type="number" 
              name="amount" 
              step="0.01"
              min="0"
              required 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="0.00"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Collector Name</label>
            <input 
              type="text" 
              name="collector_name" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Who collected this amount?"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
            <textarea 
              name="notes" 
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Additional notes about this collection"
            ></textarea>
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="closeAddCollectionModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
            Add Collection
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Subitems Modal -->
  <div id="manageSubitemsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Manage Asset Subitems</h3>
        <div class="flex items-center space-x-3">
          <button 
            onclick="openAddSubitemModal()"
            class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
          >
            <i class="fas fa-plus mr-1"></i>
            Add Subitem
          </button>
          <button onclick="closeManageSubitemsModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="subitemsContent">
          <!-- Subitems will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Subitem Modal -->
  <div id="addSubitemModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 id="subitemModalTitle" class="text-lg font-semibold text-gray-900">Add Subitem</h3>
      </div>
      <form id="addSubitemForm" class="p-6">
        <input type="hidden" id="subitemAssetId" name="asset_id">
        <input type="hidden" id="editSubitemId" name="subitem_id">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Inventory Item</label>
            <select 
              id="subitemInventoryItem"
              name="inventory_item_id" 
              required 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="">Select Inventory Item</option>
              <!-- Options will be loaded dynamically -->
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
            <input 
              type="number" 
              id="subitemQuantity"
              name="quantity" 
              min="1"
              required 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="1"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Deployment Date</label>
            <input 
              type="date" 
              id="subitemDeploymentDate"
              name="deployment_date" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select 
              id="subitemStatus"
              name="status" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="deployed">Deployed</option>
              <option value="maintenance">Maintenance</option>
              <option value="removed">Removed</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
            <textarea 
              id="subitemNotes"
              name="notes" 
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="Additional notes about this deployment"
            ></textarea>
          </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="closeAddSubitemModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            Cancel
          </button>
          <button type="submit" id="subitemSubmitBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            Add Subitem
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="notificationContainer" class="fixed bottom-4 right-4 z-50 space-y-2 max-w-sm"></div>

  <script>
    // Global variables
    let assets = [];
    let filteredAssets = [];
    let currentPage = 1;
    let itemsPerPage = 25;
    let totalPages = 1;
    let currentSort = { column: 'last_collection_date', direction: 'desc' };

    // Show notification toast
    function showNotification(title, message, type = 'info') {
      const container = document.getElementById('notificationContainer');
      
      const toastId = 'toast-' + Math.random().toString(36).substring(2, 15);
      
      let bgClass = 'bg-blue-500';
      let icon = 'info-circle';
      
      switch(type) {
        case 'success':
          icon = 'check-circle';
          bgClass = 'bg-green-500';
          break;
        case 'warning':
          icon = 'exclamation-triangle';
          bgClass = 'bg-amber-500';
          break;
        case 'error':
          icon = 'exclamation-circle';
          bgClass = 'bg-red-500';
          break;
      }
      
      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0`;
      toast.innerHTML = `
        <div class="flex items-start">
          <i class="fas fa-${icon} mt-0.5 mr-3 flex-shrink-0"></i>
          <div class="flex-1 min-w-0">
            <div class="font-semibold">${title}</div>
            <div class="text-sm opacity-90">${message}</div>
          </div>
          <button onclick="removeToast('${toastId}')" class="ml-3 flex-shrink-0 text-white/80 hover:text-white">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('translate-x-full', 'opacity-0');
      }, 10);
      
      setTimeout(() => {
        removeToast(toastId);
      }, 5000);
    }
    
    function removeToast(toastId) {
      const toast = document.getElementById(toastId);
      if (toast) {
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }
    }

    // Load assets
    async function loadAssets() {
      const token = localStorage.getItem('auth_token');
      
      try {
        const [assetsResponse, statsResponse] = await Promise.all([
          fetch('/api/assets', {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch('/api/assets/stats', {
            headers: { 'Authorization': `Bearer ${token}` }
          }).catch(() => null) // Stats endpoint might not exist, handle gracefully
        ]);
        
        if (assetsResponse.ok) {
          const data = await assetsResponse.json();
          assets = data.assets || [];
          
          // Update stats cards
          if (statsResponse && statsResponse.ok) {
            const statsData = await statsResponse.json();
            updateStatsCardsFromAPI(statsData.stats);
          } else {
            updateStatsCards(); // Fallback to client-side calculation
          }
          
          // Apply default sorting
          sortAssets(currentSort.column, currentSort.direction, false);
          renderAssets();
        } else {
          throw new Error('Failed to load assets');
        }
      } catch (error) {
        console.error('Error loading assets:', error);
        showNotification('Error', 'Failed to load assets', 'error');
      }
    }

    // Update stats cards from API data
    function updateStatsCardsFromAPI(stats) {
      document.getElementById('totalAssetsCount').textContent = parseInt(stats.total_assets).toLocaleString();
      document.getElementById('activeAssetsCount').textContent = parseInt(stats.active_assets).toLocaleString();
      document.getElementById('totalCollectionsAmount').textContent = `₱${parseFloat(stats.total_collections).toLocaleString()}`;
      document.getElementById('thisMonthCollections').textContent = `₱${parseFloat(stats.this_month_collections).toLocaleString()}`;
    }

    // Update stats cards (fallback client-side calculation)
    function updateStatsCards() {
      const totalAssets = assets.length;
      const activeAssets = assets.filter(asset => asset.status === 'active').length;
      const totalCollections = assets.reduce((sum, asset) => sum + (parseFloat(asset.total_collections) || 0), 0);
      
      // Calculate this month's collections
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      let thisMonthCollections = 0;
      
      // This is an approximation - for exact calculation, we'd need collection dates from API
      // For now, we'll estimate based on last_collection_date
      assets.forEach(asset => {
        if (asset.last_collection_date) {
          const lastCollection = new Date(asset.last_collection_date);
          if (lastCollection.getMonth() === currentMonth && lastCollection.getFullYear() === currentYear) {
            // Rough estimate - assume this month's collection is part of total
            thisMonthCollections += (parseFloat(asset.total_collections) || 0) * 0.1; // Rough 10% estimate
          }
        }
      });
      
      // Update DOM elements
      document.getElementById('totalAssetsCount').textContent = totalAssets.toLocaleString();
      document.getElementById('activeAssetsCount').textContent = activeAssets.toLocaleString();
      document.getElementById('totalCollectionsAmount').textContent = `₱${totalCollections.toLocaleString()}`;
      document.getElementById('thisMonthCollections').textContent = `₱${Math.round(thisMonthCollections).toLocaleString()}`;
    }

    // Sort table function
    function sortTable(column) {
      let direction = 'asc';
      
      // If clicking the same column, toggle direction
      if (currentSort.column === column) {
        direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      }
      
      currentSort = { column, direction };
      sortAssets(column, direction, true);
      renderAssets();
    }

    // Sort assets array
    function sortAssets(column, direction, updateUI = true) {
      assets.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        // Handle null/undefined values
        if (aVal === null || aVal === undefined) aVal = '';
        if (bVal === null || bVal === undefined) bVal = '';
        
        // Special handling for different column types
        switch (column) {
          case 'total_collections':
          case 'subitems_count':
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
            break;
          case 'last_collection_date':
            aVal = aVal ? new Date(aVal) : new Date(0);
            bVal = bVal ? new Date(bVal) : new Date(0);
            break;
          case 'name':
          case 'type':
          case 'location':
          case 'status':
            aVal = aVal.toString().toLowerCase();
            bVal = bVal.toString().toLowerCase();
            break;
        }
        
        if (direction === 'asc') {
          return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        } else {
          return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
        }
      });
      
      if (updateUI) {
        updateSortIcons(column, direction);
      }
    }

    // Update sort icons
    function updateSortIcons(activeColumn, direction) {
      // Reset all sort icons
      document.querySelectorAll('[id^="sort-"]').forEach(icon => {
        icon.className = 'fas fa-sort text-gray-400';
      });
      
      // Set active column icon
      const activeIcon = document.getElementById(`sort-${activeColumn}`);
      if (activeIcon) {
        activeIcon.className = direction === 'asc' 
          ? 'fas fa-sort-up text-blue-500' 
          : 'fas fa-sort-down text-blue-500';
      }
    }

    // Display assets
    function renderAssets() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const typeFilter = document.getElementById('typeFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      filteredAssets = assets.filter(asset => {
        const matchesSearch = asset.name.toLowerCase().includes(searchTerm) || 
                            (asset.location && asset.location.toLowerCase().includes(searchTerm)) ||
                            (asset.serial_number && asset.serial_number.toLowerCase().includes(searchTerm));
        const matchesType = !typeFilter || asset.type === typeFilter;
        const matchesStatus = !statusFilter || asset.status === statusFilter;

        return matchesSearch && matchesType && matchesStatus;
      });

      displayAssets(filteredAssets);
      updatePaginationInfo(filteredAssets.length);
    }

    // Display assets in table
    function displayAssets(assetsToDisplay) {
      const tableBody = document.getElementById('assetsTableBody');

      if (assetsToDisplay.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" class="px-6 py-12 text-center">
              <div class="text-center">
                <i class="fas fa-cube text-gray-400 text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No Assets Found</h3>
                <p class="text-gray-500 mb-4">Get started by adding your first asset</p>
                <button 
                  onclick="openAddAssetModal()"
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  <i class="fas fa-plus mr-2"></i>
                  Add Asset
                </button>
              </div>
            </td>
          </tr>
        `;
      } else {
        tableBody.innerHTML = assetsToDisplay.map(asset => `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="font-medium text-gray-900">${asset.name}</div>
              <div class="text-sm text-gray-500">${asset.description || ''}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800 capitalize">
                ${asset.type}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              ${asset.location || 'Not specified'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(asset.status)}">
                ${asset.status}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              ₱${(asset.total_collections || 0).toLocaleString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              ${asset.last_collection_date ? new Date(asset.last_collection_date).toLocaleDateString() : 'No collections'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full ${parseInt(asset.subitems_count) > 0 ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                <i class="fas fa-boxes mr-1"></i>
                ${parseInt(asset.subitems_count) || 0}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="flex items-center justify-end space-x-2">
                <button 
                  onclick="viewAsset(${asset.id})"
                  class="text-gray-600 hover:text-gray-900 p-1"
                  title="View Asset"
                >
                  <i class="fas fa-eye"></i>
                </button>
                <button 
                  onclick="viewAssetCollections(${asset.id})"
                  class="text-green-600 hover:text-green-900 p-1"
                  title="View Collections"
                >
                  <i class="fas fa-coins"></i>
                </button>
                <button 
                  onclick="manageAssetSubitems(${asset.id})"
                  class="text-purple-600 hover:text-purple-900 p-1"
                  title="Manage Subitems"
                >
                  <i class="fas fa-boxes"></i>
                </button>
                <button 
                  onclick="editAsset(${asset.id})"
                  class="text-blue-600 hover:text-blue-900 p-1"
                  title="Edit"
                >
                  <i class="fas fa-edit"></i>
                </button>
                <button 
                  onclick="deleteAsset(${asset.id})"
                  class="text-red-600 hover:text-red-900 p-1"
                  title="Delete"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }
    }

    // Get status badge class
    function getStatusBadgeClass(status) {
      const statusColors = {
        active: 'bg-green-100 text-green-800',
        inactive: 'bg-red-100 text-red-800',
        maintenance: 'bg-yellow-100 text-yellow-800'
      };
      return statusColors[status] || 'bg-gray-100 text-gray-800';
    }

    // Update pagination info
    function updatePaginationInfo(total) {
      const start = total > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
      const end = Math.min(currentPage * itemsPerPage, total);
      
      const paginationStatusEl = document.getElementById('paginationStatus');
      if (paginationStatusEl) {
        paginationStatusEl.textContent = `Showing ${start} to ${end} of ${total} entries`;
      }
    }

    // Modal functions
    function openAddAssetModal() {
      document.getElementById('addAssetModal').classList.remove('hidden');
      document.getElementById('addAssetModal').classList.add('flex');
    }

    function closeAddAssetModal() {
      document.getElementById('addAssetModal').classList.add('hidden');
      document.getElementById('addAssetModal').classList.remove('flex');
      document.getElementById('addAssetForm').reset();
    }

    // Global variable for current asset
    let currentAssetId = null;
    let availableInventoryItems = [];
    let isEditingSubitem = false;

    // View asset details
    async function viewAsset(assetId) {
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch(`/api/assets/${assetId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          const asset = data;
          
          document.getElementById('viewAssetContent').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-4">
                <div>
                  <label class="text-sm font-medium text-gray-600">Name</label>
                  <p class="text-lg font-semibold text-gray-900">${asset.name}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Type</label>
                  <p class="text-gray-900 capitalize">${asset.type}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Status</label>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(asset.status)}">
                    ${asset.status}
                  </span>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Location</label>
                  <p class="text-gray-900">${asset.location || 'Not specified'}</p>
                </div>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="text-sm font-medium text-gray-600">Serial Number</label>
                  <p class="text-gray-900">${asset.serial_number || 'Not specified'}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Model</label>
                  <p class="text-gray-900">${asset.model || 'Not specified'}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Total Collections</label>
                  <p class="text-lg font-semibold text-green-600">₱${(asset.total_collections || 0).toLocaleString()}</p>
                </div>
                <div>
                  <label class="text-sm font-medium text-gray-600">Created</label>
                  <p class="text-gray-900">${new Date(asset.created_at).toLocaleDateString()}</p>
                </div>
              </div>
            </div>
            ${asset.description ? `
              <div class="mt-6">
                <label class="text-sm font-medium text-gray-600">Description</label>
                <p class="text-gray-900 mt-1">${asset.description}</p>
              </div>
            ` : ''}
          `;
          
          openViewAssetModal();
        } else {
          throw new Error('Failed to load asset details');
        }
      } catch (error) {
        console.error('Error loading asset:', error);
        showNotification('Error', 'Failed to load asset details', 'error');
      }
    }

    // View asset collections
    async function viewAssetCollections(assetId) {
      currentAssetId = assetId;
      const token = localStorage.getItem('auth_token');
      
      try {
        const [assetResponse, collectionsResponse] = await Promise.all([
          fetch(`/api/assets/${assetId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch(`/api/assets/${assetId}/collections`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
        ]);
        
        if (assetResponse.ok && collectionsResponse.ok) {
          const asset = await assetResponse.json();
          const collectionsData = await collectionsResponse.json();
          const collections = collectionsData.collections || [];
          
          let collectionsHtml = `
            <div class="mb-4">
              <h4 class="text-lg font-semibold text-gray-900">${asset.name} - Collections</h4>
              <p class="text-gray-600">Total Collections: ₱${(asset.total_collections || 0).toLocaleString()}</p>
            </div>
          `;
          
          if (collections.length === 0) {
            collectionsHtml += `
              <div class="text-center py-8">
                <i class="fas fa-coins text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">No Collections Yet</h3>
                <p class="text-gray-500 mb-4">Start tracking collections for this asset</p>
                <button 
                  onclick="openAddCollectionModal()"
                  class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                >
                  <i class="fas fa-plus mr-2"></i>
                  Add First Collection
                </button>
              </div>
            `;
          } else {
            collectionsHtml += `
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Collector</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                      <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            collections.forEach(collection => {
              collectionsHtml += `
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${new Date(collection.collection_date).toLocaleDateString()}
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-green-600">
                    ₱${parseFloat(collection.amount).toLocaleString()}
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${collection.collector_name || 'Not specified'}
                  </td>
                  <td class="px-4 py-4 text-sm text-gray-900">
                    ${collection.notes || '-'}
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                      onclick="deleteCollection(${collection.id})"
                      class="text-red-600 hover:text-red-900 p-1"
                      title="Delete Collection"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
            });
            
            collectionsHtml += `
                  </tbody>
                </table>
              </div>
            `;
          }
          
          document.getElementById('collectionsContent').innerHTML = collectionsHtml;
          openCollectionsModal();
        } else {
          throw new Error('Failed to load collections');
        }
      } catch (error) {
        console.error('Error loading collections:', error);
        showNotification('Error', 'Failed to load asset collections', 'error');
      }
    }

    // Edit asset
    async function editAsset(assetId) {
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch(`/api/assets/${assetId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const asset = await response.json();
          
          // Populate form fields
          document.getElementById('editAssetId').value = asset.id;
          document.getElementById('editAssetName').value = asset.name;
          document.getElementById('editAssetType').value = asset.type;
          document.getElementById('editAssetDescription').value = asset.description || '';
          document.getElementById('editAssetLocation').value = asset.location || '';
          document.getElementById('editAssetStatus').value = asset.status;
          document.getElementById('editAssetSerial').value = asset.serial_number || '';
          document.getElementById('editAssetModel').value = asset.model || '';
          
          openEditAssetModal();
        } else {
          throw new Error('Failed to load asset details');
        }
      } catch (error) {
        console.error('Error loading asset for edit:', error);
        showNotification('Error', 'Failed to load asset details', 'error');
      }
    }

    // Delete asset
    async function deleteAsset(assetId) {
      if (!confirm('Are you sure you want to delete this asset? This action cannot be undone.')) {
        return;
      }
      
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch(`/api/assets/${assetId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          showNotification('Success', 'Asset deleted successfully', 'success');
          loadAssets();
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete asset');
        }
      } catch (error) {
        console.error('Error deleting asset:', error);
        showNotification('Error', error.message, 'error');
      }
    }

    // Delete collection
    async function deleteCollection(collectionId) {
      if (!confirm('Are you sure you want to delete this collection?')) {
        return;
      }
      
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch(`/api/assets/collections/${collectionId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          showNotification('Success', 'Collection deleted successfully', 'success');
          // Refresh collections view
          viewAssetCollections(currentAssetId);
          // Refresh main assets list
          loadAssets();
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete collection');
        }
      } catch (error) {
        console.error('Error deleting collection:', error);
        showNotification('Error', error.message, 'error');
      }
    }

    // Manage asset subitems
    async function manageAssetSubitems(assetId) {
      currentAssetId = assetId;
      const token = localStorage.getItem('auth_token');
      
      try {
        const [assetResponse, subitemsResponse] = await Promise.all([
          fetch(`/api/assets/${assetId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch(`/api/assets/${assetId}/subitems`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
        ]);
        
        if (assetResponse.ok && subitemsResponse.ok) {
          const asset = await assetResponse.json();
          const subitemsData = await subitemsResponse.json();
          const subitems = subitemsData.subitems || [];
          
          let subitemsHtml = `
            <div class="mb-4">
              <h4 class="text-lg font-semibold text-gray-900">${asset.name} - Deployed Items</h4>
              <p class="text-gray-600">Manage inventory items deployed with this asset</p>
            </div>
          `;
          
          if (subitems.length === 0) {
            subitemsHtml += `
              <div class="text-center py-8">
                <i class="fas fa-boxes text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-600 mb-2">No Subitems Deployed</h3>
                <p class="text-gray-500 mb-4">Start tracking inventory items deployed with this asset</p>
                <button 
                  onclick="openAddSubitemModal()"
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <i class="fas fa-plus mr-2"></i>
                  Add First Item
                </button>
              </div>
            `;
          } else {
            subitemsHtml += `
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deployment Date</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                      <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            subitems.forEach(subitem => {
              const statusColor = subitem.status === 'deployed' ? 'bg-green-100 text-green-800' : 
                                subitem.status === 'maintenance' ? 'bg-yellow-100 text-yellow-800' : 
                                'bg-red-100 text-red-800';
              
              subitemsHtml += `
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-4 whitespace-nowrap">
                    <div>
                      <div class="text-sm font-medium text-gray-900">${subitem.item_name}</div>
                      ${subitem.sku ? `<div class="text-sm text-gray-500">SKU: ${subitem.sku}</div>` : ''}
                    </div>
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${subitem.category_name || 'Uncategorized'}
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${subitem.quantity}
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                      ${subitem.status}
                    </span>
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${subitem.deployment_date ? new Date(subitem.deployment_date).toLocaleDateString() : 'Not specified'}
                  </td>
                  <td class="px-4 py-4 text-sm text-gray-900">
                    ${subitem.notes || '-'}
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                      onclick="editSubitem(${subitem.id})"
                      class="text-blue-600 hover:text-blue-900 p-1 mr-2"
                      title="Edit Subitem"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                    <button 
                      onclick="deleteSubitem(${subitem.id})"
                      class="text-red-600 hover:text-red-900 p-1"
                      title="Remove Subitem"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
            });
            
            subitemsHtml += `
                  </tbody>
                </table>
              </div>
            `;
          }
          
          document.getElementById('subitemsContent').innerHTML = subitemsHtml;
          openManageSubitemsModal();
        } else {
          throw new Error('Failed to load subitems');
        }
      } catch (error) {
        console.error('Error loading subitems:', error);
        showNotification('Error', 'Failed to load asset subitems', 'error');
      }
    }

    // Load available inventory items
    async function loadInventoryItems() {
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch('/api/assets/inventory-items', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          availableInventoryItems = data.items || [];
          populateInventoryItemSelect();
        } else {
          throw new Error('Failed to load inventory items');
        }
      } catch (error) {
        console.error('Error loading inventory items:', error);
        showNotification('Error', 'Failed to load inventory items', 'error');
      }
    }

    // Populate inventory item select dropdown
    function populateInventoryItemSelect() {
      const select = document.getElementById('subitemInventoryItem');
      select.innerHTML = '<option value="">Select Inventory Item</option>';
      
      availableInventoryItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        const stock = item.quantity_in_stock || item.quantity_on_hand || 0;
        option.textContent = `${item.name} ${item.sku ? `(${item.sku})` : ''} - Stock: ${stock}`;
        select.appendChild(option);
      });
    }

    // Edit subitem
    async function editSubitem(subitemId) {
      const token = localStorage.getItem('auth_token');
      
      try {
        // Get current subitems to find the one being edited
        const response = await fetch(`/api/assets/${currentAssetId}/subitems`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          const subitem = data.subitems.find(s => s.id === subitemId);
          
          if (subitem) {
            isEditingSubitem = true;
            
            // Populate form
            document.getElementById('editSubitemId').value = subitem.id;
            document.getElementById('subitemInventoryItem').value = subitem.inventory_item_id;
            document.getElementById('subitemQuantity').value = subitem.quantity;
            document.getElementById('subitemDeploymentDate').value = subitem.deployment_date || '';
            document.getElementById('subitemStatus').value = subitem.status;
            document.getElementById('subitemNotes').value = subitem.notes || '';
            
            // Update modal title and button
            document.getElementById('subitemModalTitle').textContent = 'Edit Subitem';
            document.getElementById('subitemSubmitBtn').textContent = 'Update Subitem';
            
            // Disable inventory item selection during edit
            document.getElementById('subitemInventoryItem').disabled = true;
            
            openAddSubitemModal();
          }
        }
      } catch (error) {
        console.error('Error loading subitem for edit:', error);
        showNotification('Error', 'Failed to load subitem details', 'error');
      }
    }

    // Delete subitem
    async function deleteSubitem(subitemId) {
      if (!confirm('Are you sure you want to remove this subitem from the asset?')) {
        return;
      }
      
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch(`/api/assets/subitems/${subitemId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          showNotification('Success', 'Subitem removed successfully', 'success');
          // Refresh subitems view
          manageAssetSubitems(currentAssetId);
          // Refresh main assets list
          loadAssets();
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete subitem');
        }
      } catch (error) {
        console.error('Error deleting subitem:', error);
        showNotification('Error', error.message, 'error');
      }
    }

    // Modal control functions
    function openViewAssetModal() {
      const modal = document.getElementById('viewAssetModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
    }

    function closeViewAssetModal() {
      const modal = document.getElementById('viewAssetModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modal.style.display = 'none';
    }

    function openEditAssetModal() {
      const modal = document.getElementById('editAssetModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
    }

    function closeEditAssetModal() {
      const modal = document.getElementById('editAssetModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modal.style.display = 'none';
      document.getElementById('editAssetForm').reset();
    }

    function openCollectionsModal() {
      const modal = document.getElementById('collectionsModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
    }

    function closeCollectionsModal() {
      const modal = document.getElementById('collectionsModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modal.style.display = 'none';
    }

    function openAddCollectionModal() {
      // Set the asset ID
      document.getElementById('collectionAssetId').value = currentAssetId;
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      document.querySelector('#addCollectionForm input[name="collection_date"]').value = today;
      
      const modal = document.getElementById('addCollectionModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
    }

    function closeAddCollectionModal() {
      const modal = document.getElementById('addCollectionModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modal.style.display = 'none';
      document.getElementById('addCollectionForm').reset();
    }

    function openManageSubitemsModal() {
      const modal = document.getElementById('manageSubitemsModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
    }

    function closeManageSubitemsModal() {
      const modal = document.getElementById('manageSubitemsModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modal.style.display = 'none';
    }

    function openAddSubitemModal() {
      // Load inventory items if not already loaded
      if (availableInventoryItems.length === 0) {
        loadInventoryItems();
      }
      
      // Set the asset ID
      document.getElementById('subitemAssetId').value = currentAssetId;
      
      // Reset form if not editing
      if (!isEditingSubitem) {
        document.getElementById('addSubitemForm').reset();
        document.getElementById('subitemAssetId').value = currentAssetId;
        document.getElementById('subitemModalTitle').textContent = 'Add Subitem';
        document.getElementById('subitemSubmitBtn').textContent = 'Add Subitem';
        document.getElementById('subitemInventoryItem').disabled = false;
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('subitemDeploymentDate').value = today;
      }
      
      const modal = document.getElementById('addSubitemModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
    }

    function closeAddSubitemModal() {
      const modal = document.getElementById('addSubitemModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modal.style.display = 'none';
      document.getElementById('addSubitemForm').reset();
      isEditingSubitem = false;
      document.getElementById('subitemInventoryItem').disabled = false;
    }

    // Page navigation placeholder
    function changePage(direction) {
      showNotification('Info', 'Pagination coming soon!', 'info');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      // Set up logout functionality
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user');
        showNotification('Logged Out', 'You have been successfully logged out', 'info');
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 1000);
      });

      // Load username
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.username) {
        document.getElementById('username').textContent = user.username;
      }

      // Set up search and filters
      document.getElementById('searchInput').addEventListener('input', renderAssets);
      document.getElementById('typeFilter').addEventListener('change', renderAssets);
      document.getElementById('statusFilter').addEventListener('change', renderAssets);

      // Set initial sort indicators
      updateSortIcons(currentSort.column, currentSort.direction);
      
      // Load assets
      loadAssets();
    });

    // Add asset form submission
    document.getElementById('addAssetForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const assetData = Object.fromEntries(formData);
      
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch('/api/assets', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(assetData)
        });
        
        if (response.ok) {
          showNotification('Success', 'Asset added successfully', 'success');
          closeAddAssetModal();
          loadAssets();
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to add asset');
        }
      } catch (error) {
        console.error('Error adding asset:', error);
        showNotification('Error', error.message, 'error');
      }
    });

    // Edit asset form submission
    document.getElementById('editAssetForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const assetData = Object.fromEntries(formData);
      const assetId = assetData.id;
      
      // Remove id from assetData since it's not needed in the request body
      delete assetData.id;
      
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch(`/api/assets/${assetId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(assetData)
        });
        
        if (response.ok) {
          showNotification('Success', 'Asset updated successfully', 'success');
          closeEditAssetModal();
          loadAssets();
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to update asset');
        }
      } catch (error) {
        console.error('Error updating asset:', error);
        showNotification('Error', error.message, 'error');
      }
    });

    // Add collection form submission
    document.getElementById('addCollectionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const collectionData = Object.fromEntries(formData);
      const assetId = collectionData.asset_id;
      
      // Remove asset_id from collectionData since it's in the URL
      delete collectionData.asset_id;
      
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch(`/api/assets/${assetId}/collections`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(collectionData)
        });
        
        if (response.ok) {
          showNotification('Success', 'Collection added successfully', 'success');
          closeAddCollectionModal();
          // Refresh collections view
          viewAssetCollections(assetId);
          // Refresh main assets list to update totals
          loadAssets();
        } else {
          const error = await response.json();
          throw new Error(error.error || 'Failed to add collection');
        }
      } catch (error) {
        console.error('Error adding collection:', error);
        showNotification('Error', error.message, 'error');
      }
    });

    // Add/Edit subitem form submission
    document.getElementById('addSubitemForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const subitemData = Object.fromEntries(formData);
      const assetId = subitemData.asset_id;
      const subitemId = subitemData.subitem_id;
      
      // Remove IDs from subitemData since they're in the URL or not needed
      delete subitemData.asset_id;
      delete subitemData.subitem_id;
      
      const token = localStorage.getItem('auth_token');
      
      try {
        let response;
        if (isEditingSubitem && subitemId) {
          // Update existing subitem
          response = await fetch(`/api/assets/subitems/${subitemId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(subitemData)
          });
        } else {
          // Create new subitem
          response = await fetch(`/api/assets/${assetId}/subitems`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(subitemData)
          });
        }
        
        if (response.ok) {
          const action = isEditingSubitem ? 'updated' : 'added';
          showNotification('Success', `Subitem ${action} successfully`, 'success');
          closeAddSubitemModal();
          // Refresh subitems view
          manageAssetSubitems(assetId);
          // Refresh main assets list to update subitems count
          loadAssets();
        } else {
          const error = await response.json();
          throw new Error(error.error || `Failed to ${isEditingSubitem ? 'update' : 'add'} subitem`);
        }
      } catch (error) {
        console.error('Error with subitem:', error);
        showNotification('Error', error.message, 'error');
      }
    });
  </script>
</body>
</html>