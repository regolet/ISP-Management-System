<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ISP Management System Settings">
  <title>ISP Management System - Settings</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  
  
  
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-inter">
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-gradient-to-b from-blue-700 to-blue-800 text-white shadow-xl flex flex-col">
      <!-- Logo -->
      <div class="p-4 border-b border-blue-600">
        <a href="/dashboard.html" class="flex items-center space-x-3 hover:opacity-90 transition-opacity">
          <i class="fas fa-signal text-2xl"></i>
          <h1 class="text-xl font-bold">ISP Management</h1>
        </a>
      </div>
      
      <!-- Navigation -->
      <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
        <a href="/dashboard.html" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-tachometer-alt w-5"></i>
          <span>Dashboard</span>
        </a>
        <a href="/clients.html" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-users w-5"></i>
          <span>Clients</span>
        </a>
        <a href="/plans.html" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-project-diagram w-5"></i>
          <span>Plans</span>
        </a>
        <a href="/billings.html" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-file-invoice-dollar w-5"></i>
          <span>Billings</span>
        </a>
        <a href="/payments.html" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-credit-card w-5"></i>
          <span>Payments</span>
        </a>
        <a href="/assets.html" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-cube w-5"></i>
          <span>Assets</span>
        </a>
        <a href="/inventory.html" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-boxes w-5"></i>
          <span>Inventory</span>
        </a>
        <a href="/tickets.html" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-ticket-alt w-5"></i>
          <span>Tickets</span>
        </a>
        <a href="/monitoring.html" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-white/10 transition-colors text-white/90 hover:text-white">
          <i class="fas fa-chart-line w-5"></i>
          <span>Monitoring</span>
        </a>
        <a href="/settings.html" class="flex items-center space-x-3 px-3 py-2 rounded-md bg-white/20 text-white font-medium">
          <i class="fas fa-cogs w-5"></i>
          <span>Settings</span>
        </a>
      </nav>
      
      <!-- User Info -->
      <div class="p-4 border-t border-blue-600">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <i class="fas fa-user-circle text-2xl"></i>
            <span id="username" class="font-medium">Administrator</span>
          </div>
          <button 
            id="logoutBtn"
            class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors text-sm font-medium"
          >
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Top Header -->
      <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <h2 class="text-2xl font-bold text-gray-900">Settings</h2>
            <!-- Global Offline Indicator -->
            <div id="globalOfflineIndicator" class="hidden">
              <div class="bg-yellow-100 border border-yellow-400 text-yellow-800 px-3 py-1 rounded-full text-xs font-medium flex items-center">
                <i class="fas fa-wifi-slash mr-1"></i>
                Offline Mode
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <span class="text-gray-600 text-sm">System configuration</span>
          </div>
        </div>
      </header>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto bg-gray-100">
        <div class="flex h-full">
          <!-- Settings Sidebar -->
          <div class="w-64 bg-white shadow-sm border-r border-gray-200">
            <div class="p-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">Settings Menu</h3>
            </div>
            <nav class="p-4 space-y-1">
              <button onclick="showSettingsTab('company')" class="settings-tab-btn active w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center text-gray-700">
                <i class="fas fa-building w-5 mr-3 text-blue-600"></i>
                <span>Company Information</span>
              </button>
              <button onclick="showSettingsTab('mikrotik')" class="settings-tab-btn w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center text-gray-700">
                <i class="fas fa-network-wired w-5 mr-3 text-red-600"></i>
                <span>MikroTik Integration</span>
              </button>
              <button onclick="showSettingsTab('updates')" class="settings-tab-btn w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center text-gray-700">
                <i class="fas fa-download w-5 mr-3 text-purple-600"></i>
                <span>System Updates</span>
              </button>
              <button onclick="showSettingsTab('scheduler')" class="settings-tab-btn w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center text-gray-700">
                <i class="fas fa-clock w-5 mr-3 text-green-600"></i>
                <span>Network Scheduler</span>
              </button>
              <button onclick="showSettingsTab('management')" class="settings-tab-btn w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors flex items-center text-gray-700">
                <i class="fas fa-cog w-5 mr-3 text-gray-600"></i>
                <span>Database Management</span>
              </button>
            </nav>
          </div>

          <!-- Settings Content Area -->
          <div class="flex-1 p-6">
            <!-- Company Information Tab -->
            <div id="company-tab" class="settings-tab-content">
              <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                  <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-building text-blue-600 mr-2"></i>
                    Company Information
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">Configure your company details and branding</p>
                </div>
                <div class="p-6">
                <form id="companyInfoForm" class="space-y-4">
                  <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-building text-gray-400"></i>
                      </div>
                      <input 
                        type="text" 
                        id="companyName" 
                        name="company_name"
                        required
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter company name"
                      >
                    </div>
                  </div>
                  
                  <div>
                    <label for="companyAddress" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <div class="relative">
                      <div class="absolute top-3 left-0 pl-3 flex items-start pointer-events-none">
                        <i class="fas fa-map-marker-alt text-gray-400"></i>
                      </div>
                      <textarea 
                        id="companyAddress" 
                        name="address"
                        rows="2" 
                        required
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter company address"
                      ></textarea>
                    </div>
                  </div>
                  
                  <div>
                    <label for="companyPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-phone text-gray-400"></i>
                      </div>
                      <input 
                        type="text" 
                        id="companyPhone" 
                        name="phone"
                        required
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter phone number"
                      >
                    </div>
                  </div>
                  
                  <div>
                    <label for="companyEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-envelope text-gray-400"></i>
                      </div>
                      <input 
                        type="email" 
                        id="companyEmail" 
                        name="email"
                        required
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter email address"
                      >
                    </div>
                  </div>
                  
                  <div>
                    <label for="companyWebsite" class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-globe text-gray-400"></i>
                      </div>
                      <input 
                        type="url" 
                        id="companyWebsite"
                        name="website"
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter website URL (optional)"
                      >
                    </div>
                  </div>
                  
                  <div class="pt-4">
                    <button 
                      type="submit"
                      class="w-full flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                      <i class="fas fa-save mr-2"></i>
                      Save Company Info
                    </button>
                  </div>
                </form>
                </div>
              </div>
            </div>

            <!-- MikroTik Integration Tab -->
            <div id="mikrotik-tab" class="settings-tab-content hidden">
              <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                  <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-network-wired text-orange-600 mr-2"></i>
                    MikroTik Integration
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">Configure MikroTik RouterOS API connection for network monitoring</p>
                </div>
                <div class="p-6">
                <form id="mikrotikForm" class="space-y-4">
                  <div>
                    <label for="mikrotik_host" class="block text-sm font-medium text-gray-700 mb-1">Router IP Address</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-server text-gray-400"></i>
                      </div>
                      <input 
                        type="text" 
                        id="mikrotik_host" 
                        name="host" 
                        required
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="192.168.1.1"
                      >
                    </div>
                  </div>
                  
                  <div>
                    <label for="mikrotik_username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-user text-gray-400"></i>
                      </div>
                      <input 
                        type="text" 
                        id="mikrotik_username" 
                        name="username" 
                        required
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="admin"
                      >
                    </div>
                  </div>
                  
                  <div>
                    <label for="mikrotik_password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-lock text-gray-400"></i>
                      </div>
                      <input 
                        type="password" 
                        id="mikrotik_password" 
                        name="password" 
                        required
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter password"
                      >
                    </div>
                  </div>
                  
                  <div>
                    <label for="mikrotik_port" class="block text-sm font-medium text-gray-700 mb-1">API Port</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-plug text-gray-400"></i>
                      </div>
                      <input 
                        type="number" 
                        id="mikrotik_port" 
                        name="port" 
                        value="8728" 
                        min="1" 
                        max="65535"
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                    </div>
                  </div>
                  
                  <div class="flex flex-col gap-3 pt-4">
                    <button 
                      type="button" 
                      onclick="testConnection()"
                      class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
                    >
                      <i class="fas fa-exchange-alt mr-2"></i>
                      Test Connection
                    </button>
                    <button 
                      type="submit"
                      class="w-full flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                      <i class="fas fa-save mr-2"></i>
                      Save Settings
                    </button>
                  </div>
                </form>
                
                <div id="connectionStatus" class="mt-4"></div>
                </div>
              </div>
            </div>

            <!-- System Updates Tab -->
            <div id="updates-tab" class="settings-tab-content hidden">
              <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                  <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-download text-purple-600 mr-2"></i>
                    System Updates
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">Manage system updates and backups</p>
                </div>
                <div class="p-6">
                  <!-- Current Version Info -->
                  <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h4 class="text-sm font-medium text-gray-900 mb-3">Current Version</h4>
                <div id="currentVersionInfo" class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Commit:</span>
                    <span id="currentCommit" class="text-sm font-mono text-gray-900">Loading...</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-sm text-gray-600">Date:</span>
                    <span id="currentDate" class="text-sm text-gray-900">Loading...</span>
                  </div>
                  <div class="mt-2">
                    <span class="text-sm text-gray-600">Message:</span>
                    <p id="currentMessage" class="text-sm text-gray-900 mt-1">Loading...</p>
                  </div>
                </div>
              </div>

                  <!-- Update Check Section -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button 
                  onclick="checkForUpdates()" 
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center">
                  <i class="fas fa-sync-alt mr-2"></i>
                  Check for Updates
                </button>
                <button 
                  onclick="createBackup()" 
                  class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center">
                  <i class="fas fa-save mr-2"></i>
                  Create Backup
                </button>
              </div>

                  <!-- Update Status -->
                  <div id="updateStatus" class="mb-6"></div>

                  <!-- Available Update Info -->
                  <div id="updateInfo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h4 class="text-sm font-medium text-blue-900 mb-3">Update Available</h4>
                <div id="updateDetails" class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-sm text-blue-700">New Commit:</span>
                    <span id="newCommit" class="text-sm font-mono text-blue-900"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-sm text-blue-700">Date:</span>
                    <span id="newDate" class="text-sm text-blue-900"></span>
                  </div>
                  <div class="mt-2">
                    <span class="text-sm text-blue-700">Message:</span>
                    <p id="newMessage" class="text-sm text-blue-900 mt-1"></p>
                  </div>
                  <div class="mt-4 flex space-x-3">
                    <button 
                      onclick="performUpdate(true)" 
                      class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center text-sm">
                      <i class="fas fa-download mr-2"></i>
                      Update with Backup
                    </button>
                    <button 
                      onclick="performUpdate(false)" 
                      class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center text-sm">
                      <i class="fas fa-exclamation-triangle mr-2"></i>
                      Update without Backup
                    </button>
                  </div>
                </div>
              </div>

                  <!-- Backup List -->
                  <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-3">
                      <h4 class="text-sm font-medium text-gray-900">Recent Backups</h4>
                      <button 
                        onclick="loadBackupList()" 
                        class="text-blue-600 hover:text-blue-700 text-sm">
                        <i class="fas fa-refresh mr-1"></i>
                        Refresh
                      </button>
                    </div>
                    <div id="backupList" class="space-y-2">
                      <p class="text-sm text-gray-500">Loading backups...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <!-- Network Scheduler Tab -->
            <div id="scheduler-tab" class="settings-tab-content hidden">
              <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                  <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-clock text-green-600 mr-2"></i>
                    Network Monitoring Scheduler
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">Configure data collection intervals and monitoring frequency</p>
                </div>
                <div class="p-6">
                  <div id="schedulerNotification" class="mb-4 hidden"></div>
                
                  <div class="space-y-6">
                    <!-- Current Settings Display -->
                    <div class="space-y-4">
                      <h4 class="text-md font-medium text-gray-800">Current Configuration</h4>
                    
                    <div class="p-4 bg-gray-50 rounded-lg space-y-3">
                      <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Collection Interval:</span>
                        <span id="currentInterval" class="text-sm font-medium text-gray-900">10 seconds</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Daily Data Points:</span>
                        <span id="dailyDataPoints" class="text-sm font-medium text-gray-900">8,640</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Storage Per Day:</span>
                        <span id="storagePerDay" class="text-sm font-medium text-gray-900">~350 KB</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Status:</span>
                        <span id="schedulerStatus" class="text-sm font-medium text-green-600">Active</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Interval Settings -->
                  <div class="space-y-4">
                    <h4 class="text-md font-medium text-gray-800">Change Collection Interval</h4>
                    
                    <div class="space-y-3">
                      <label for="intervalSelect" class="block text-sm font-medium text-gray-700">Select Interval:</label>
                      <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                          <i class="fas fa-clock text-gray-400"></i>
                        </div>
                        <select 
                          id="intervalSelect" 
                          onchange="setSchedulerInterval(this.value)"
                          class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                          <option value="10s" selected>10 seconds (High detail)</option>
                          <option value="30s">30 seconds (Detailed)</option>
                          <option value="1m">1 minute (Standard)</option>
                          <option value="5m">5 minutes (Low detail)</option>
                          <option value="15m">15 minutes (Minimal)</option>
                          <option value="30m">30 minutes (Very minimal)</option>
                        </select>
                      </div>
                      
                      <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-start">
                          <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 mt-0.5"></i>
                          <div class="text-sm text-yellow-800">
                            <strong>Note:</strong> Shorter intervals provide more detailed data but use more storage. 
                            Requires server restart to take effect.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                    <div class="flex gap-3">
                      <button 
                        onclick="applySchedulerSettings()"
                        class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
                      >
                        <i class="fas fa-save mr-2"></i>
                        Apply Settings
                      </button>
                      
                      <button 
                        onclick="restartScheduler()"
                        class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                      >
                        <i class="fas fa-sync-alt mr-2"></i>
                        Restart Scheduler
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Database Management Tab -->
            <div id="management-tab" class="settings-tab-content hidden">
              <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                  <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-database text-purple-600 mr-2"></i>
                    Database Management
                  </h3>
                  <p class="text-sm text-gray-600 mt-1">Monitor and manage database health and operations</p>
                </div>
                <div class="p-6">
                  <div id="databaseNotification" class="mb-4 hidden"></div>
                  
                  <!-- Local Database Section -->
                  <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                      <i class="fas fa-database text-blue-600 mr-2"></i>
                      Local Database (SQLite)
                    </h4>
                    
                    <!-- Database Status -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-blue-50 rounded-lg mb-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Connection Status</label>
                        <div id="dbConnectionStatus" class="text-sm">
                          <span class="text-gray-500">Checking...</span>
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tables Status</label>
                        <div id="dbTablesStatus" class="text-sm">
                          <span class="text-gray-500">Checking...</span>
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Check</label>
                        <div id="dbLastCheck" class="text-sm text-gray-600">Never</div>
                      </div>
                    </div>

                    <!-- Database Actions -->
                    <div class="flex flex-wrap gap-3 mb-4">
                      <button 
                        onclick="checkDatabaseHealth()"
                        class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                      >
                        <i class="fas fa-stethoscope mr-2"></i>
                        Check Health
                      </button>
                      
                      <button 
                        onclick="initializeDatabase()"
                        class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
                      >
                        <i class="fas fa-plus-circle mr-2"></i>
                        Initialize
                      </button>
                      
                      <button 
                        onclick="repairDatabase()"
                        class="flex items-center px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors font-medium"
                      >
                        <i class="fas fa-wrench mr-2"></i>
                        Repair
                      </button>
                      
                      <button 
                        onclick="resetDatabase()"
                        class="flex items-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                      >
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Reset
                      </button>
                    </div>
                    
                    <div class="text-sm text-gray-600 bg-gray-50 rounded-lg p-3 space-y-1">
                      <p><strong>Initialize:</strong> Create database tables and default data</p>
                      <p><strong>Repair:</strong> Fix common database issues and rebuild indexes</p>
                      <p><strong>Reset:</strong> ⚠️ Delete all data and recreate tables (cannot be undone)</p>
                    </div>
                  </div>

                  <!-- Cloud Backup & Sync Section -->
                  <div class="border-t border-gray-200 pt-8">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                      <i class="fas fa-cloud-upload-alt text-green-600 mr-2"></i>
                      Cloud Backup & Sync (Supabase)
                    </h4>
                      
                      <!-- Supabase Configuration -->
                      <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="space-y-4">
                          <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Supabase URL</label>
                            <input 
                              type="text" 
                              id="supabaseUrl"
                              placeholder="https://your-project.supabase.co"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                            />
                          </div>
                          <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Supabase Anon Key</label>
                            <input 
                              type="password" 
                              id="supabaseAnonKey"
                              placeholder="Your Supabase anon key"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                            />
                          </div>
                          <div class="flex gap-3">
                            <button 
                              onclick="saveSupabaseConfig()"
                              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
                            >
                              <i class="fas fa-save mr-2"></i>
                              Save Configuration
                            </button>
                            <button 
                              onclick="testSupabaseConnection()"
                              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                            >
                              <i class="fas fa-plug mr-2"></i>
                              Test Connection
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- Sync Status -->
                      <div class="bg-blue-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Connection Status</label>
                            <div id="supabaseStatus" class="text-sm">
                              <span class="text-gray-500">Not configured</span>
                            </div>
                          </div>
                          <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Sync</label>
                            <div id="supabaseLastSync" class="text-sm text-gray-600">Never</div>
                          </div>
                          <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Local Records</label>
                            <div id="localRecordCount" class="text-sm text-gray-600">-</div>
                          </div>
                        </div>
                      </div>

                      <!-- Sync Progress -->
                      <div id="supabaseSyncProgress" class="hidden mb-4">
                        <div class="bg-gray-200 rounded-full h-3 mb-2">
                          <div id="supabaseSyncBar" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between items-center">
                          <span id="supabaseSyncText" class="text-sm text-gray-600">Preparing...</span>
                          <span id="supabaseSyncPercent" class="text-sm font-medium text-gray-900">0%</span>
                        </div>
                      </div>

                      <!-- Sync Actions -->
                      <div class="flex gap-3">
                        <button 
                          onclick="uploadToSupabase()"
                          id="uploadToSupabaseBtn"
                          class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                          disabled
                        >
                          <i class="fas fa-cloud-upload-alt mr-2"></i>
                          Upload to Online
                        </button>
                        
                        <button 
                          onclick="viewSupabaseSchema()"
                          class="flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium"
                        >
                          <i class="fas fa-code mr-2"></i>
                          View Schema SQL
                        </button>
                      </div>

                      <div class="mt-4 text-sm text-gray-600 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="flex items-start">
                          <i class="fas fa-info-circle text-yellow-600 mr-2 mt-0.5"></i>
                          <span>
                            <strong>Important:</strong> Before uploading, ensure you have created the database schema in Supabase. 
                            Click "View Schema SQL" to get the SQL commands, then run them in your Supabase SQL Editor.
                          </span>
                        </p>
                      </div>
                    </div>
                  </div>
              </div>
            </div>

          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="notificationContainer" class="fixed bottom-4 right-4 z-50 space-y-2 max-w-sm"></div>

  <script>
    // Globals
    let settings = {};

    // Settings Tab Management
    function showSettingsTab(tabName) {
      // Hide all tab content
      const allTabs = document.querySelectorAll('.settings-tab-content');
      allTabs.forEach(tab => tab.classList.add('hidden'));
      
      // Remove active class from all buttons
      const allButtons = document.querySelectorAll('.settings-tab-btn');
      allButtons.forEach(btn => btn.classList.remove('active', 'bg-blue-100', 'text-blue-700'));
      
      // Show selected tab
      const selectedTab = document.getElementById(tabName + '-tab');
      if (selectedTab) {
        selectedTab.classList.remove('hidden');
      }
      
      // Add active class to clicked button
      const clickedButton = event?.target.closest('.settings-tab-btn');
      if (clickedButton) {
        clickedButton.classList.add('active', 'bg-blue-100', 'text-blue-700');
      }
      
      // Load tab-specific data
      loadTabData(tabName);
    }
    
    // Load data for specific tabs
    function loadTabData(tabName) {
      switch(tabName) {
        case 'database':
          checkDatabaseStatus();
          break;
        case 'scheduler':
          updateSchedulerStats();
          break;
        case 'management':
          checkDatabaseHealth();
          break;
        case 'company':
          loadCompanyInfo();
          break;
        case 'mikrotik':
          loadMikrotikSettings();
          break;
        case 'updates':
          loadCurrentVersion();
          loadBackupList();
          break;
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Hide all tabs initially
      const allTabs = document.querySelectorAll('.settings-tab-content');
      allTabs.forEach(tab => tab.classList.add('hidden'));
      
      // Show company tab by default
      const companyTab = document.getElementById('company-tab');
      if (companyTab) {
        companyTab.classList.remove('hidden');
      }
      
      // Set first button as active
      const firstButton = document.querySelector('.settings-tab-btn');
      if (firstButton) {
        firstButton.classList.add('active', 'bg-blue-100', 'text-blue-700');
      }
    });

    // Show notification
    function showNotification(title, message, type = 'info') {
      const notificationContainer = document.getElementById('notificationContainer');
      
      const typeClasses = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      const notification = document.createElement('div');
      notification.className = `${typeClasses[type]} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-y-full opacity-0`;
      notification.innerHTML = `
        <div class="flex items-start">
          <div class="flex-1">
            <h4 class="font-semibold">${title}</h4>
            <p class="text-sm mt-1">${message}</p>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      notificationContainer.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.classList.remove('translate-y-full', 'opacity-0');
      }, 100);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.classList.add('translate-y-full', 'opacity-0');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }
      }, 5000);
    }

    // Load company information
    async function loadCompanyInfo() {
      try {
        const response = await fetch('/api/company-info', {
        });
        
        if (response.ok) {
          const data = await response.json();
          // API returns data directly, not wrapped in data.company
          if (data && typeof data === 'object') {
            document.getElementById('companyName').value = data.company_name || '';
            document.getElementById('companyAddress').value = data.address || '';
            document.getElementById('companyPhone').value = data.phone || '';
            document.getElementById('companyEmail').value = data.email || '';
            document.getElementById('companyWebsite').value = data.website || '';
          }
        }
      } catch (error) {
        console.error('Error loading company info:', error);
        showNotification('Error', 'Failed to load company information', 'error');
      }
    }

    // Load MikroTik settings
    async function loadMikrotikSettings() {
      try {
        const response = await fetch('/api/mikrotik/settings', {
        });
        
        if (response.ok) {
          const data = await response.json();
          // API returns data directly, not wrapped in data.settings
          if (data && typeof data === 'object') {
            document.getElementById('mikrotik_host').value = data.host || '';
            document.getElementById('mikrotik_username').value = data.username || '';
            document.getElementById('mikrotik_port').value = data.port || 8728;
            // Don't populate password field for security reasons
          }
        }
      } catch (error) {
        console.error('Error loading MikroTik settings:', error);
        showNotification('Error', 'Failed to load MikroTik settings', 'error');
      }
    }

    // Test MikroTik connection
    async function testConnection() {
      const host = document.getElementById('mikrotik_host').value;
      const username = document.getElementById('mikrotik_username').value;
      const password = document.getElementById('mikrotik_password').value;
      const port = document.getElementById('mikrotik_port').value;

      if (!host || !username || !password) {
        showNotification('Error', 'Please fill in all required fields', 'error');
        return;
      }

      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Testing connection...</div>';

      try {
        const response = await fetch('/api/mikrotik/test', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ host, username, password, port: parseInt(port) })
        });

        const data = await response.json();
        
        if (response.ok && data.success) {
          statusDiv.innerHTML = '<div class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Connection successful!</div>';
          showNotification('Success', 'MikroTik connection test successful', 'success');
        } else {
          statusDiv.innerHTML = `<div class="text-red-600"><i class="fas fa-times-circle mr-2"></i>Connection failed: ${data.error || 'Unknown error'}</div>`;
          showNotification('Error', `Connection failed: ${data.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-times-circle mr-2"></i>Connection failed</div>';
        showNotification('Error', 'Connection test failed', 'error');
      }
    }

    // Database management functions
    async function checkDatabaseHealth() {
      try {
        const response = await fetch('/api/health', {
        });
        
        if (response.ok) {
          const data = await response.json();
          updateDatabaseStatus('connected', 'healthy', new Date().toLocaleString());
          showNotification('Success', 'Database is healthy', 'success');
        } else {
          updateDatabaseStatus('disconnected', 'error', new Date().toLocaleString());
          showNotification('Error', 'Database connection failed', 'error');
        }
      } catch (error) {
        updateDatabaseStatus('disconnected', 'error', new Date().toLocaleString());
        showNotification('Error', 'Failed to check database health', 'error');
      }
    }

    async function initializeDatabase() {
      if (!confirm('This will create database tables and initialize default data. Continue?')) return;
      
      try {
        const response = await fetch('/api/init-database', {
          method: 'POST',
        });
        
        if (response.ok) {
          showNotification('Success', 'Database initialized successfully', 'success');
          checkDatabaseHealth();
        } else {
          const data = await response.json();
          showNotification('Error', data.message || 'Failed to initialize database', 'error');
        }
      } catch (error) {
        showNotification('Error', 'Failed to initialize database', 'error');
      }
    }

    async function repairDatabase() {
      if (!confirm('This will attempt to repair database issues. Continue?')) return;
      
      showNotification('Info', 'Database repair functionality coming soon!', 'info');
    }

    async function resetDatabase() {
      if (!confirm('⚠️ WARNING: This will DELETE ALL DATA and cannot be undone! Are you absolutely sure?')) return;
      if (!confirm('This action cannot be reversed. Type YES to confirm:') || 
          prompt('Type "DELETE ALL DATA" to confirm:') !== 'DELETE ALL DATA') return;
      
      try {
        const response = await fetch('/api/reset-database', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ confirm: 'RESET' })
        });
        
        if (response.ok) {
          showNotification('Success', 'Database reset successfully', 'success');
          checkDatabaseHealth();
        } else {
          const data = await response.json();
          showNotification('Error', data.message || 'Failed to reset database', 'error');
        }
      } catch (error) {
        showNotification('Error', 'Failed to reset database', 'error');
      }
    }

    function updateDatabaseStatus(connectionStatus, tablesStatus, lastCheck) {
      const dbConnectionStatus = document.getElementById('dbConnectionStatus');
      const dbTablesStatus = document.getElementById('dbTablesStatus');
      const dbLastCheck = document.getElementById('dbLastCheck');
      
      // Update connection status
      if (dbConnectionStatus) {
        if (connectionStatus === 'connected') {
          dbConnectionStatus.innerHTML = '<span class="text-green-600 font-medium">Connected</span>';
        } else {
          dbConnectionStatus.innerHTML = '<span class="text-red-600 font-medium">Disconnected</span>';
        }
      }
      
      // Update tables status
      if (dbTablesStatus) {
        if (tablesStatus === 'healthy') {
          dbTablesStatus.innerHTML = '<span class="text-green-600 font-medium">Healthy</span>';
        } else if (tablesStatus === 'error') {
          dbTablesStatus.innerHTML = '<span class="text-red-600 font-medium">Error</span>';
        } else {
          dbTablesStatus.innerHTML = '<span class="text-yellow-600 font-medium">Unknown</span>';
        }
      }
      
      // Update last check
      if (dbLastCheck) {
        dbLastCheck.textContent = lastCheck || 'Never';
      }
    }

    // Form submission handlers
    document.getElementById('companyInfoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        company_name: document.getElementById('companyName').value,
        address: document.getElementById('companyAddress').value,
        phone: document.getElementById('companyPhone').value,
        email: document.getElementById('companyEmail').value,
        website: document.getElementById('companyWebsite').value
      };

      try {
        const response = await fetch('/api/company-info', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          showNotification('Success', 'Company information saved successfully', 'success');
        } else {
          const data = await response.json();
          showNotification('Error', data.error || 'Failed to save company information', 'error');
        }
      } catch (error) {
        showNotification('Error', 'Failed to save company information', 'error');
      }
    });

    document.getElementById('mikrotikForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        host: document.getElementById('mikrotik_host').value,
        username: document.getElementById('mikrotik_username').value,
        password: document.getElementById('mikrotik_password').value,
        port: parseInt(document.getElementById('mikrotik_port').value)
      };

      try {
        const response = await fetch('/api/mikrotik/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          showNotification('Success', 'MikroTik settings saved successfully', 'success');
          document.getElementById('connectionStatus').innerHTML = '';
        } else {
          const data = await response.json();
          showNotification('Error', data.error || 'Failed to save MikroTik settings', 'error');
        }
      } catch (error) {
        showNotification('Error', 'Failed to save MikroTik settings', 'error');
      }
    });

    // Global scheduler management functions
    function setSchedulerInterval(interval) {
      // Update display
      const currentInterval = document.getElementById('currentInterval');
      const dailyDataPoints = document.getElementById('dailyDataPoints');
      const storagePerDay = document.getElementById('storagePerDay');
      
      // Update current interval display
      const intervalMap = {
        '10s': '10 seconds',
        '30s': '30 seconds', 
        '1m': '1 minute',
        '5m': '5 minutes',
        '15m': '15 minutes',
        '30m': '30 minutes'
      };
      
      currentInterval.textContent = intervalMap[interval] || interval;
      
      // Calculate data points per day
      const secondsMap = {
        '10s': 10,
        '30s': 30,
        '1m': 60,
        '5m': 300,
        '15m': 900,
        '30m': 1800
      };
      
      const seconds = secondsMap[interval] || 10;
      const pointsPerDay = Math.floor(86400 / seconds); // 86400 seconds in a day
      dailyDataPoints.textContent = pointsPerDay.toLocaleString();
      
      // Estimate storage (rough calculation: ~40 bytes per record)
      const storageBytes = pointsPerDay * 40;
      const storageKB = storageBytes / 1024;
      storagePerDay.textContent = `~${Math.round(storageKB)} KB`;
      
      // Store the setting
      localStorage.setItem('schedulerInterval', interval);
    }

    async function updateSchedulerStats() {
      
      try {
        // Get current settings from server
        const response = await fetch('/api/scheduler/settings', {
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            const currentInterval = result.interval || '10s';
            
            // Update dropdown and display
            const intervalSelect = document.getElementById('intervalSelect');
            if (intervalSelect) {
              intervalSelect.value = currentInterval;
              setSchedulerInterval(currentInterval);
            }
            
            // Save to localStorage for consistency
            localStorage.setItem('schedulerInterval', currentInterval);
            
            // Update scheduler status
            const statusEl = document.getElementById('schedulerStatus');
            if (statusEl) {
              statusEl.textContent = 'Active';
              statusEl.className = 'text-sm font-medium text-green-600';
            }
          } else {
            throw new Error(result.error || 'Failed to get scheduler settings');
          }
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        console.error('Error loading scheduler settings:', error);
        
        // Fallback to localStorage
        const currentInterval = localStorage.getItem('schedulerInterval') || '10s';
        const intervalSelect = document.getElementById('intervalSelect');
        
        if (intervalSelect) {
          intervalSelect.value = currentInterval;
          setSchedulerInterval(currentInterval);
        }
        
        // Update scheduler status to error
        const statusEl = document.getElementById('schedulerStatus');
        if (statusEl) {
          statusEl.textContent = 'Error';
          statusEl.className = 'text-sm font-medium text-red-600';
        }
        
        // Show error notification
        showNotification('Scheduler Error', `Failed to load scheduler settings: ${error.message}`, 'error');
      }
    }

    async function applySchedulerSettings() {
      const interval = document.getElementById('intervalSelect').value;
      
      try {
        const response = await fetch('/api/scheduler/interval', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ interval })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          // Save to localStorage for display
          localStorage.setItem('schedulerInterval', interval);
          
          // Update display
          setSchedulerInterval(interval);
          
          showNotification('Settings Applied', `Scheduler interval updated to ${interval} and restarted automatically.`, 'success');
        } else {
          showNotification('Error', result.error || 'Failed to update scheduler settings', 'error');
        }
      } catch (error) {
        console.error('Error applying scheduler settings:', error);
        showNotification('Error', 'Failed to update scheduler settings', 'error');
      }
    }

    async function restartScheduler() {
      if (!confirm('Restart the data collection scheduler? This will briefly interrupt data collection.')) {
        return;
      }
      
      
      try {
        const response = await fetch('/api/scheduler/restart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showNotification('Scheduler Restarted', result.message, 'success');
        } else {
          showNotification('Error', result.error || 'Failed to restart scheduler', 'error');
        }
      } catch (error) {
        console.error('Error restarting scheduler:', error);
        showNotification('Error', 'Failed to restart scheduler', 'error');
      }
    }


    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication


      // Load username
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.username) {
        document.getElementById('username').textContent = user.username;
      }

      // Load settings for initial tab only
      loadTabData('company'); // Load company tab data since it's shown by default
    });

    // System Update Management Functions
    async function loadCurrentVersion() {
      try {
        const response = await fetch('/api/system/version', {
        });
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('currentCommit').textContent = data.version.commit;
          document.getElementById('currentDate').textContent = new Date(data.version.date).toLocaleString();
          document.getElementById('currentMessage').textContent = data.version.message;
        }
      } catch (error) {
        console.error('Error loading version:', error);
        document.getElementById('currentCommit').textContent = 'Error loading';
        document.getElementById('currentDate').textContent = 'Error loading';
        document.getElementById('currentMessage').textContent = 'Error loading version information';
      }
    }

    async function checkForUpdates() {
      const statusDiv = document.getElementById('updateStatus');
      statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3"><i class="fas fa-spinner fa-spin mr-2"></i>Checking for updates...</div>';
      
      try {
        const response = await fetch('/api/system/check-updates', {
        });
        const data = await response.json();
        
        if (data.success) {
          if (data.updates.available) {
            document.getElementById('updateInfo').classList.remove('hidden');
            document.getElementById('newCommit').textContent = data.updates.latest.commit;
            document.getElementById('newDate').textContent = new Date(data.updates.latest.date).toLocaleString();
            document.getElementById('newMessage').textContent = data.updates.latest.message;
            
            statusDiv.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-green-800">
              <i class="fas fa-check-circle mr-2"></i>Update available! ${data.updates.commitsBehind} commit(s) behind.
            </div>`;
          } else {
            document.getElementById('updateInfo').classList.add('hidden');
            statusDiv.innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-green-800"><i class="fas fa-check-circle mr-2"></i>System is up to date!</div>';
          }
        } else {
          statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800">
            <i class="fas fa-exclamation-circle mr-2"></i>Error: ${data.error}
          </div>`;
        }
      } catch (error) {
        console.error('Error checking updates:', error);
        statusDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800"><i class="fas fa-exclamation-circle mr-2"></i>Failed to check for updates</div>';
      }
    }

    async function createBackup() {
      const statusDiv = document.getElementById('updateStatus');
      statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3"><i class="fas fa-spinner fa-spin mr-2"></i>Creating backup...</div>';
      
      try {
        const response = await fetch('/api/system/backup', {
          method: 'POST',
        });
        const data = await response.json();
        
        if (data.success) {
          statusDiv.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-green-800">
            <i class="fas fa-check-circle mr-2"></i>Backup created successfully: ${data.backup.timestamp}
          </div>`;
          loadBackupList();
        } else {
          statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800">
            <i class="fas fa-exclamation-circle mr-2"></i>Error: ${data.error}
          </div>`;
        }
      } catch (error) {
        console.error('Error creating backup:', error);
        statusDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800"><i class="fas fa-exclamation-circle mr-2"></i>Failed to create backup</div>';
      }
    }

    async function performUpdate(createBackupFirst) {
      const statusDiv = document.getElementById('updateStatus');
      statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3"><i class="fas fa-spinner fa-spin mr-2"></i>Updating system...</div>';
      
      try {
        const response = await fetch('/api/system/update', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ createBackup: createBackupFirst })
        });
        const data = await response.json();
        
        if (data.success) {
          statusDiv.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-green-800">
            <i class="fas fa-check-circle mr-2"></i>Update completed! New version: ${data.update.newVersion}
            ${data.update.backup ? `<br><small>Backup: ${data.update.backup.timestamp}</small>` : ''}
          </div>`;
          
          document.getElementById('updateInfo').classList.add('hidden');
          
          if (data.update.restartRequired) {
            statusDiv.innerHTML += `<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-yellow-800 mt-3">
              <i class="fas fa-exclamation-triangle mr-2"></i>Server restart required. 
              <button onclick="restartServer()" class="ml-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
                Restart Now
              </button>
            </div>`;
          }
          
          loadCurrentVersion();
          loadBackupList();
        } else {
          statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800">
            <i class="fas fa-exclamation-circle mr-2"></i>Error: ${data.error}
          </div>`;
        }
      } catch (error) {
        console.error('Error performing update:', error);
        statusDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800"><i class="fas fa-exclamation-circle mr-2"></i>Failed to perform update</div>';
      }
    }

    async function restartServer() {
      const statusDiv = document.getElementById('updateStatus');
      statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3"><i class="fas fa-spinner fa-spin mr-2"></i>Restarting server...</div>';
      
      try {
        await fetch('/api/system/restart', {
          method: 'POST',
        });
        
        statusDiv.innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-green-800"><i class="fas fa-check-circle mr-2"></i>Server restart initiated. Please refresh the page in a few seconds.</div>';
        
        setTimeout(() => {
          window.location.reload();
        }, 5000);
        
      } catch (error) {
        console.error('Error restarting server:', error);
        statusDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800"><i class="fas fa-exclamation-circle mr-2"></i>Failed to restart server</div>';
      }
    }

    async function loadBackupList() {
      const backupDiv = document.getElementById('backupList');
      
      try {
        const response = await fetch('/api/system/backups', {
        });
        const data = await response.json();
        
        if (data.success) {
          if (data.backups && data.backups.length > 0) {
            backupDiv.innerHTML = data.backups.slice(0, 5).map(backup => `
              <div class="flex justify-between items-center py-2 px-3 bg-white rounded border">
                <div>
                  <div class="text-sm font-medium text-gray-900">${backup.name}</div>
                  <div class="text-xs text-gray-500">${new Date(backup.created).toLocaleString()}</div>
                </div>
                <div class="text-xs text-gray-500">${(backup.size / 1024 / 1024).toFixed(2)} MB</div>
              </div>
            `).join('');
          } else {
            backupDiv.innerHTML = '<p class="text-sm text-gray-500">No backups found</p>';
          }
        } else {
          backupDiv.innerHTML = '<p class="text-sm text-red-500">Error loading backups</p>';
        }
      } catch (error) {
        console.error('Error loading backups:', error);
        backupDiv.innerHTML = '<p class="text-sm text-red-500">Failed to load backups</p>';
      }
    }

    // Database Status and Sync Management Functions
    async function checkDatabaseStatus() {
      try {
        const response = await fetch('/api/database/status', {
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          const db = data.database;
          
          // Update status display
          const dbModeEl = document.getElementById('dbMode');
          const dbStatusEl = document.getElementById('dbStatus');
          const syncQueueEl = document.getElementById('syncQueue');
          
          if (dbModeEl) dbModeEl.textContent = db.mode || 'Unknown';
          if (dbStatusEl) dbStatusEl.textContent = db.status || 'Unknown';
          if (syncQueueEl) syncQueueEl.textContent = db.syncQueue > 0 ? `${db.syncQueue} items` : 'Empty';
          
          // Update icon color based on status
          const icon = document.getElementById('dbStatusIcon');
          if (icon) {
            if (db.isOnline) {
              icon.className = 'fas fa-database text-green-600 mr-2';
            } else {
              icon.className = 'fas fa-database text-yellow-600 mr-2';
            }
          }
          
          // Update mode toggle buttons
          updateModeButtons(db.isOnline);
          
          // Show/hide sync button based on queue
          const syncButton = document.getElementById('syncButton');
          if (syncButton) {
            if (db.syncQueue > 0 && db.isOnline) {
              syncButton.classList.remove('opacity-50', 'cursor-not-allowed');
              syncButton.disabled = false;
            } else {
              syncButton.classList.add('opacity-50', 'cursor-not-allowed');
              syncButton.disabled = true;
            }
          }
          
        } else {
          throw new Error(data.error || 'Unknown API error');
        }
      } catch (error) {
        console.error('Error checking database status:', error);
        
        const dbModeEl = document.getElementById('dbMode');
        const dbStatusEl = document.getElementById('dbStatus');
        const syncQueueEl = document.getElementById('syncQueue');
        
        if (dbModeEl) dbModeEl.textContent = 'Error';
        if (dbStatusEl) dbStatusEl.textContent = 'Failed to check status';
        if (syncQueueEl) syncQueueEl.textContent = 'Unknown';
        
        // Show error notification
        showNotification('Database Error', `Failed to check database status: ${error.message}`, 'error');
      }
    }


    async function getOfflineSummary() {
      try {
        const response = await fetch('/api/database/offline-summary', {
        });
        const data = await response.json();
        
        if (data.success) {
          const summaryDiv = document.getElementById('offlineDataSummary');
          const detailsDiv = document.getElementById('offlineDataDetails');
          
          if (data.offlineData && data.offlineData.totalPending > 0) {
            const pending = data.offlineData.pendingSync;
            
            detailsDiv.innerHTML = Object.entries(pending)
              .filter(([table, count]) => count > 0)
              .map(([table, count]) => `
                <div class="flex justify-between items-center py-1">
                  <span class="text-sm text-yellow-800 capitalize">${table.replace('_', ' ')}:</span>
                  <span class="text-sm font-medium text-yellow-900">${count} pending</span>
                </div>
              `).join('') + `
                <div class="mt-3 pt-2 border-t border-yellow-300">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-yellow-800">Total Pending:</span>
                    <span class="text-sm font-bold text-yellow-900">${data.offlineData.totalPending} items</span>
                  </div>
                </div>
              `;
            
            summaryDiv.classList.remove('hidden');
          } else {
            summaryDiv.classList.add('hidden');
            
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.innerHTML = '<div class="bg-green-50 border border-green-200 rounded-lg p-3 text-green-800"><i class="fas fa-check-circle mr-2"></i>No offline data pending sync</div>';
            
            setTimeout(() => {
              statusDiv.innerHTML = '';
            }, 3000);
          }
        }
      } catch (error) {
        console.error('Error getting offline summary:', error);
        const statusDiv = document.getElementById('syncStatus');
        statusDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800"><i class="fas fa-exclamation-circle mr-2"></i>Failed to get offline summary</div>';
      }
    }

    // Database Management Functions (SQLite-only system)

    // Update UI state (SQLite-only system)
    function updateModeButtons(isOnline) {
      const offlineWarning = document.getElementById('offlineWarning');
      const globalOfflineIndicator = document.getElementById('globalOfflineIndicator');
      
      // Always hide offline warnings since SQLite is the primary mode
      if (offlineWarning) {
        offlineWarning.classList.add('hidden');
      }
      if (globalOfflineIndicator) {
        globalOfflineIndicator.classList.add('hidden');
      }
    }

    // Test database connection
    async function testDatabaseConnection() {
      const statusDiv = document.getElementById('syncStatus');
      statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-lg p-3"><i class="fas fa-spinner fa-spin mr-2"></i>Testing database connection...</div>';
      
      try {
        const response = await fetch('/api/database/status?test=true', {
        });
        
        const data = await response.json();
        
        if (data.success && data.connectionTest) {
          const test = data.connectionTest;
          const statusClass = test.connected ? 'green' : 'red';
          const icon = test.connected ? 'check-circle' : 'times-circle';
          
          statusDiv.innerHTML = `
            <div class="bg-${statusClass}-50 border border-${statusClass}-200 rounded-lg p-4">
              <div class="flex items-start">
                <i class="fas fa-${icon} text-${statusClass}-600 mr-3 mt-1"></i>
                <div>
                  <div class="font-medium text-${statusClass}-800">
                    ${test.connected ? 'Connection Successful' : 'Connection Failed'}
                  </div>
                  <div class="text-sm text-${statusClass}-700 mt-1">
                    <div>Response Time: ${test.responseTime}</div>
                    <div>Connection String: <code class="text-xs">${test.connectionString}</code></div>
                    <div>SSL: ${test.ssl}</div>
                    <div>Current Mode: ${data.database.mode}</div>
                    <div class="mt-2 font-medium">${test.advice}</div>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Also update the main status display
          updateDatabaseStatusDisplay(data.database);
        } else {
          statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800">
            <i class="fas fa-exclamation-circle mr-2"></i>Test failed: ${data.error || 'Unknown error'}
          </div>`;
        }
      } catch (error) {
        console.error('Error testing connection:', error);
        statusDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800"><i class="fas fa-exclamation-circle mr-2"></i>Failed to test connection</div>';
      }
    }
    
    // Helper function to update database status display
    function updateDatabaseStatusDisplay(db) {
      const dbModeEl = document.getElementById('dbMode');
      const dbStatusEl = document.getElementById('dbStatus');
      const syncQueueEl = document.getElementById('syncQueue');
      
      if (dbModeEl) dbModeEl.textContent = db.mode || 'Unknown';
      if (dbStatusEl) dbStatusEl.textContent = db.status || 'Unknown';
      if (syncQueueEl) syncQueueEl.textContent = db.syncQueue > 0 ? `${db.syncQueue} items` : 'Empty';
    }

    // Force online mode (bypass connectivity check)
    async function forceOnlineMode() {
      if (!confirm('Force online mode? This bypasses connectivity checks and may cause errors if the database is unreachable. Continue?')) {
        return;
      }
      
      const statusDiv = document.getElementById('syncStatus');
      statusDiv.innerHTML = '<div class="bg-orange-50 border border-orange-200 rounded-lg p-3"><i class="fas fa-spinner fa-spin mr-2"></i>Forcing online mode...</div>';
      
      try {
        const response = await fetch('/api/database/switch-online', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ forceOnline: true })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Success', data.message, 'success');
          if (data.warning) {
            showNotification('Warning', data.warning, 'warning');
          }
          // Refresh status
          setTimeout(() => {
            checkDatabaseStatus();
            statusDiv.innerHTML = '';
          }, 2000);
        } else {
          statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800">
            <i class="fas fa-exclamation-circle mr-2"></i>Failed: ${data.error}
          </div>`;
        }
      } catch (error) {
        console.error('Error forcing online mode:', error);
        statusDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800"><i class="fas fa-exclamation-circle mr-2"></i>Failed to force online mode</div>';
      }
    }

    // Progress bar utilities
    function showProgress(text = 'Processing...') {
      const container = document.getElementById('syncProgressContainer');
      const progressBar = document.getElementById('syncProgressBar');
      const progressText = document.getElementById('syncProgressText');
      const progressPercent = document.getElementById('syncProgressPercent');
      
      container.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = text;
      progressPercent.textContent = '0%';
    }

    function updateProgress(percent, text) {
      const progressBar = document.getElementById('syncProgressBar');
      const progressText = document.getElementById('syncProgressText');
      const progressPercent = document.getElementById('syncProgressPercent');
      
      progressBar.style.width = `${percent}%`;
      progressText.textContent = text;
      progressPercent.textContent = `${Math.round(percent)}%`;
    }

    function hideProgress() {
      const container = document.getElementById('syncProgressContainer');
      container.classList.add('hidden');
    }

    // Initialize offline database
    async function initializeOfflineDatabase() {
      if (!confirm('This will repair the offline database schema to match online database structure. This fixes sync errors and ensures compatibility. Continue?')) {
        return;
      }
      
      const btn = document.getElementById('initOfflineBtn');
      const originalText = btn.innerHTML;
      
      // Show loading state
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Initializing...';
      showProgress('Initializing offline database...');
      
      try {
        updateProgress(30, 'Repairing database schema...');
        
        const response = await fetch('/api/database/init-offline', {
          method: 'POST',
        });
        
        updateProgress(80, 'Synchronizing schema with PostgreSQL...');
        const data = await response.json();
        
        if (data.success) {
          updateProgress(100, 'Database schema repaired and synchronized!');
          showNotification('Success', 'Offline database schema repaired and synchronized with online database', 'success');
          
          setTimeout(() => {
            hideProgress();
            checkDatabaseStatus();
          }, 2000);
        } else {
          hideProgress();
          showNotification('Error', data.error || 'Failed to initialize offline database', 'error');
        }
      } catch (error) {
        console.error('Error initializing offline database:', error);
        hideProgress();
        showNotification('Error', 'Failed to initialize offline database', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // Download data from online to offline
    async function downloadDataToOffline() {
      if (!confirm('This will download all online data to your offline database. Any existing offline data will be overwritten. Continue?')) {
        return;
      }
      
      const btn = document.getElementById('downloadDataBtn');
      const originalText = btn.innerHTML;
      
      // Show loading state
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Downloading...';
      showProgress('Connecting to online database...');
      
      try {
        updateProgress(10, 'Checking online database connection...');
        
        const response = await fetch('/api/database/download-data', {
          method: 'POST',
        });
        
        updateProgress(30, 'Starting data download...');
        
        // Simulate progress updates while waiting for response
        const progressInterval = setInterval(() => {
          const currentProgress = parseInt(document.getElementById('syncProgressBar').style.width);
          if (currentProgress < 90) {
            updateProgress(currentProgress + 5, 'Downloading data from online database...');
          }
        }, 500);
        
        const data = await response.json();
        clearInterval(progressInterval);
        
        if (data.success) {
          updateProgress(100, `Download completed! ${data.summary || 'Data downloaded successfully'}`);
          showNotification('Success', data.summary || 'Data downloaded successfully to offline database', 'success');
          
          setTimeout(() => {
            hideProgress();
            checkDatabaseStatus();
          }, 3000);
        } else {
          hideProgress();
          showNotification('Error', data.error || 'Failed to download data', 'error');
        }
      } catch (error) {
        console.error('Error downloading data:', error);
        hideProgress();
        showNotification('Error', 'Failed to download data to offline database', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // Auto-refresh database status every 30 seconds
    setInterval(checkDatabaseStatus, 30000);

    // ==========================================
    // Supabase Integration Functions
    // ==========================================

    // Load Supabase configuration on page load
    async function loadSupabaseConfig() {
      try {
        const response = await fetch('/api/supabase/config');
        const data = await response.json();
        
        if (data.success && data.configured) {
          document.getElementById('supabaseUrl').value = data.url || '';
          document.getElementById('supabaseStatus').innerHTML = 
            '<span class="text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i>Configured</span>';
          document.getElementById('uploadToSupabaseBtn').disabled = false;
          
          if (data.lastSync) {
            const syncDate = new Date(data.lastSync);
            document.getElementById('supabaseLastSync').textContent = syncDate.toLocaleString();
          }
        } else {
          document.getElementById('supabaseStatus').innerHTML = 
            '<span class="text-gray-500">Not configured</span>';
        }
        
        // Load sync status
        loadSupabaseSyncStatus();
      } catch (error) {
        console.error('Error loading Supabase config:', error);
      }
    }

    // Save Supabase configuration
    async function saveSupabaseConfig() {
      const url = document.getElementById('supabaseUrl').value.trim();
      const anonKey = document.getElementById('supabaseAnonKey').value.trim();
      
      if (!url || !anonKey) {
        showNotification('Error', 'Please enter both Supabase URL and Anon Key', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/supabase/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, anonKey })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Success', 'Supabase configuration saved successfully', 'success');
          document.getElementById('supabaseStatus').innerHTML = 
            '<span class="text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i>Configured</span>';
          document.getElementById('uploadToSupabaseBtn').disabled = false;
          
          if (data.connectionTest && data.connectionTest.needsSchema) {
            showNotification('Info', 'Database schema needs to be created in Supabase. Click "View Schema SQL" for the SQL commands.', 'info');
          }
        } else {
          showNotification('Error', data.error || 'Failed to save configuration', 'error');
        }
      } catch (error) {
        console.error('Error saving Supabase config:', error);
        showNotification('Error', 'Failed to save configuration', 'error');
      }
    }

    // Test Supabase connection
    async function testSupabaseConnection() {
      try {
        const response = await fetch('/api/supabase/test-connection', {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Enable upload button after successful test
          document.getElementById('uploadToSupabaseBtn').disabled = false;
          document.getElementById('supabaseStatus').innerHTML = 
            '<span class="text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i>Connected</span>';
          
          if (data.needsSchema) {
            showNotification('Warning', 'Connection successful but database schema not found. Please create the schema first.', 'warning');
          } else {
            showNotification('Success', 'Supabase connection successful!', 'success');
          }
        } else {
          showNotification('Error', data.error || 'Connection failed', 'error');
        }
      } catch (error) {
        console.error('Error testing connection:', error);
        showNotification('Error', 'Failed to test connection', 'error');
      }
    }

    // View Supabase schema SQL
    async function viewSupabaseSchema() {
      try {
        const response = await fetch('/api/supabase/schema-sql');
        const data = await response.json();
        
        if (data.success) {
          // Create modal to display SQL
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[80vh] flex flex-col">
              <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Supabase Database Schema SQL</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="p-6 overflow-y-auto flex-1">
                <div class="mb-4 text-sm text-gray-600">
                  <p class="mb-2">Copy this SQL and run it in your Supabase SQL Editor:</p>
                  <ol class="list-decimal list-inside space-y-1">
                    <li>Go to your Supabase Dashboard</li>
                    <li>Navigate to SQL Editor</li>
                    <li>Create a new query</li>
                    <li>Paste this SQL and run it</li>
                  </ol>
                </div>
                <div class="relative">
                  <pre class="bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto text-sm">${data.sql}</pre>
                  <button 
                    onclick="copyToClipboard(this.previousElementSibling.textContent)"
                    class="absolute top-2 right-2 px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm"
                  >
                    <i class="fas fa-copy mr-1"></i> Copy
                  </button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        } else {
          showNotification('Error', data.error || 'Failed to get schema SQL', 'error');
        }
      } catch (error) {
        console.error('Error getting schema SQL:', error);
        showNotification('Error', 'Failed to get schema SQL', 'error');
      }
    }

    // Upload data to Supabase
    async function uploadToSupabase() {
      if (!confirm('This will upload all local data to Supabase, replacing any existing data. Continue?')) {
        return;
      }
      
      const btn = document.getElementById('uploadToSupabaseBtn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
      
      // Show progress
      const progressContainer = document.getElementById('supabaseSyncProgress');
      const progressBar = document.getElementById('supabaseSyncBar');
      const progressText = document.getElementById('supabaseSyncText');
      const progressPercent = document.getElementById('supabaseSyncPercent');
      
      progressContainer.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = 'Connecting to Supabase...';
      progressPercent.textContent = '0%';
      
      try {
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          if (progress < 90) {
            progress += 10;
            progressBar.style.width = progress + '%';
            progressPercent.textContent = progress + '%';
            progressText.textContent = 'Uploading data to Supabase...';
          }
        }, 500);
        
        const response = await fetch('/api/supabase/sync', {
          method: 'POST'
        });
        
        clearInterval(progressInterval);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Sync request failed:', response.status, errorText);
          throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Check if any data was actually synced
        const hasSyncedData = data.results && data.results.tables && 
          Object.values(data.results.tables).some(table => table.success && table.count > 0);
        
        if (data.success || hasSyncedData) {
          progressBar.style.width = '100%';
          progressPercent.textContent = '100%';
          
          if (data.success) {
            progressText.textContent = 'Upload completed successfully!';
            showNotification('Success', data.message || 'Data uploaded to Supabase successfully', 'success');
          } else {
            // Partial success
            const syncedTables = Object.entries(data.results.tables)
              .filter(([table, result]) => result.success && result.count > 0);
            const totalRecords = syncedTables.reduce((sum, [table, result]) => sum + result.count, 0);
            
            progressText.textContent = `Partial upload completed: ${totalRecords} records`;
            showNotification('Warning', 
              `Partially uploaded: ${totalRecords} records synced. Some tables had errors (check RLS policies).`, 
              'warning');
          }
          
          // Update last sync time
          document.getElementById('supabaseLastSync').textContent = new Date().toLocaleString();
          
          // Log results
          if (data.results && data.results.tables) {
            console.log('Sync results:', data.results.tables);
            
            // Show detailed results
            const successfulTables = Object.entries(data.results.tables)
              .filter(([table, result]) => result.success && result.count > 0)
              .map(([table, result]) => `${table}: ${result.count} records`);
            
            if (successfulTables.length > 0) {
              console.log('Successfully synced:', successfulTables.join(', '));
            }
          }
          
          setTimeout(() => {
            progressContainer.classList.add('hidden');
          }, 3000);
        } else {
          progressContainer.classList.add('hidden');
          
          if (data.needsSchema) {
            showNotification('Error', 'Database schema not found in Supabase. Please create the schema first.', 'error');
          } else {
            showNotification('Error', data.error || 'Failed to upload data', 'error');
          }
        }
      } catch (error) {
        console.error('Error uploading to Supabase:', error);
        progressContainer.classList.add('hidden');
        showNotification('Error', `Failed to upload data: ${error.message || 'Unknown error'}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // Load Supabase sync status
    async function loadSupabaseSyncStatus() {
      try {
        const response = await fetch('/api/supabase/status');
        const data = await response.json();
        
        if (data.success && data.localDataCounts) {
          const totalRecords = Object.values(data.localDataCounts).reduce((a, b) => a + b, 0);
          document.getElementById('localRecordCount').textContent = totalRecords + ' total records';
        }
      } catch (error) {
        console.error('Error loading sync status:', error);
      }
    }

    // Copy to clipboard helper
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showNotification('Success', 'Copied to clipboard', 'success');
      }).catch(() => {
        showNotification('Error', 'Failed to copy to clipboard', 'error');
      });
    }

    // Load Supabase config on Database Management tab
    const originalShowSettingsTab = showSettingsTab;
    showSettingsTab = function(tabName) {
      originalShowSettingsTab(tabName);
      if (tabName === 'management') {
        loadSupabaseConfig();
      }
    };

    // Auto-refresh database status every 30 seconds
    setInterval(checkDatabaseStatus, 30000);

  </script>
</body>
</html>